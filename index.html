<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöö Solana France - Dashboard Logistique PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif;}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#e2e8f0 100%);color:#1f2937;min-height:100vh;}
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#00b4d8,#0077b6);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .login-card{background:#fff;border-radius:24px;padding:50px 60px;box-shadow:0 30px 60px rgba(0,0,0,.3);max-width:450px;width:90%;text-align:center;}
    .login-card h1{font-size:2.5rem;color:#0077b6;margin-bottom:15px;}
    .login-input{width:100%;padding:18px;border:2px solid #e5e7eb;border-radius:16px;font-size:18px;margin:20px 0;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:all .3s;}
    .login-input:focus{border-color:#00b4d8;box-shadow:0 0 0 3px rgba(0,180,216,.2);}
    .login-btn{width:100%;padding:18px;background:#00b4d8;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(0,180,216,.4);transition:all .3s;}
    .login-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,180,216,.5);}
    .dashboard{display:none;padding:30px;max-width:1400px;margin:0 auto;}
    .header{position:relative;background:#fff;border-radius:24px 24px 0 0;padding:35px 40px;box-shadow:0 20px 40px rgba(0,0,0,.15);margin:-30px -30px 0;}
    .header h1{font-size:2.3rem;color:#0077b6;margin-bottom:10px;}
    .logout-btn{position:absolute;top:35px;right:40px;background:#ef4444;color:white;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 5px 15px rgba(239,68,68,.4);transition:all .3s;}
    .logout-btn:hover{transform:translateY(-2px);}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:25px;margin:35px 0;}
    .kpi-card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);text-align:center;transition:all .3s;cursor:pointer;}
    .kpi-card:hover{transform:translateY(-8px);box-shadow:0 25px 50px rgba(0,0,0,.2);}
    .kpi-icon{font-size:4rem;margin-bottom:15px;}
    .kpi-value{font-size:3rem;font-weight:800;color:#0077b6;margin-bottom:8px;}
    .kpi-label{font-size:1.1rem;color:#6b7280;font-weight:500;}
    .add-section{background:#fff;border-radius:20px;padding:35px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    .add-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
    .form-group label{font-weight:600;color:#374151;margin-bottom:8px;display:block;}
    .form-input{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .form-input:focus{border-color:#00b4d8;outline:none;box-shadow:0 0 0 3px rgba(0,180,216,.1);}
    .add-btn{grid-column:1/-1;padding:20px;background:#10b981;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(16,185,129,.4);transition:all .3s;}
    .add-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(16,185,129,.5);}
    .table-container{overflow-x:auto;background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    table{width:100%;border-collapse:collapse;}
    th{padding:20px 15px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);color:#374151;font-weight:700;font-size:1rem;border-bottom:4px solid #e5e7eb;}
    td{padding:18px 15px;border-bottom:2px solid #f3f4f6;vertical-align:middle;}
    tr:hover{background:#f8fafc;}
    tr.chargee{background:#f0fdf4;}
    .action-btn{min-width:100px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;margin:1px;font-size:.85rem;}
    .btn-confirmer{background:#10b981;color:white;box-shadow:0 4px 12px rgba(16,185,129,.4);}
    .btn-confirmer:hover{background:#059669;transform:translateY(-1px);}
    .btn-resent{background:#f59e0b;color:white;box-shadow:0 4px 12px rgba(245,158,11,.4);}
    .btn-resent:hover{background:#d97706;transform:translateY(-1px);}
    .btn-supprimer{background:#ef4444;color:white;box-shadow:0 4px 12px rgba(239,68,68,.4);}
    .btn-supprimer:hover{background:#dc2626;transform:translateY(-1px);}
    .graph-clients {background: #fff;border-radius: 20px;padding: 25px;box-shadow: 0 15px 35px rgba(0,0,0,.12);margin: 30px 0;}
    .graph-title {color: #0077b6;font-size: 1.5rem;margin-bottom: 20px;text-align: center;}
    .client-bar {display: flex;align-items: center;margin: 12px 0;background: #f1f5f9;border-radius: 12px;padding: 15px;transition: all .3s;}
    .client-bar:hover {transform: translateX(10px);box-shadow: 0 10px 25px rgba(0,180,216,.2);}
    .client-name {font-weight: 700;color: #374151;min-width: 120px;}
    .client-tonnes {font-weight: 800;color: #0077b6;margin-left: 20px;}
    .client-barre {flex: 1;height: 25px;background: linear-gradient(90deg, #10b981, #00b4d8);border-radius: 12px;margin: 0 20px;position: relative;overflow: hidden;}
    .client-pourcent {position: absolute;right: 10px;color: white;font-weight: 600;}
    .export-section {display: flex; gap: 15px; margin: 20px 0; padding: 20px;background: linear-gradient(135deg, #f0fdf4, #d1fae5);border-radius: 20px; border: 2px solid #10b981;}
    .export-btn {flex: 1; padding: 15px 20px; border: none; border-radius: 15px;font-weight: 700; font-size: 16px; cursor: pointer; transition: all .3s;display: flex; align-items: center; gap: 10px; justify-content: center;}
    .btn-excel { background: #059669; color: white; }
    .btn-excel:hover { background: #047857; transform: scale(1.05); }
    .btn-save { background: #8b5cf6; color: white; }
    .btn-save:hover { background: #7c3aed; transform: scale(1.05); }
    .btn-sync { background: #10b981; color: white; }
    .btn-sync:hover { background: #059669; transform: scale(1.05); }
    .map-section {background: #fff; border-radius: 20px; padding: 25px;box-shadow: 0 15px 35px rgba(0,0,0,.12); margin: 30px 0;}
    .map-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;}
    .map-card {background: linear-gradient(135deg, #f0fdf4, #d1fae5); border: 3px solid #10b981; border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: all .3s;}
    .map-card:hover {transform: scale(1.05); box-shadow: 0 15px 35px rgba(16,185,129,.3);}
    .map-flag {font-size: 3rem; margin-bottom: 10px;}
    .map-tonnes {font-size: 1.8rem; font-weight: 800; color: #10b981; margin-bottom: 5px;}
    .map-cmds {color: #6b7280; font-weight: 600;}
    .country-detail {background: #fff; border-radius: 16px; padding: 25px; border-left: 6px solid #10b981; display: none;}
    .country-detail.active {display: block; animation: slideIn 0.3s ease;}
    @keyframes slideIn {from {opacity: 0; transform: translateX(-20px);} to {opacity: 1; transform: translateX(0);}}
    .detail-table {width: 100%; margin-top: 20px; border-collapse: collapse;}
    .detail-table th, .detail-table td {padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb;}
    .detail-table th {background: #f0fdf4; font-weight: 700; color: #374151;}
    .loading {color: #f59e0b; font-size: 1.2rem; padding: 40px; text-align: center;}
    .error-message {color: #dc2626; padding: 20px; background: #fef2f2; border-radius: 12px; margin: 20px 0; border-left: 5px solid #ef4444;}
    #saveStatus {font-size: 0.9rem; margin-left: 5px;}
    .supabase-status {background: #10b981;color:white;padding:10px;border-radius:12px;margin:10px 0;font-weight:600;}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1>üöö Solana Logistique PRO</h1>
    <p style="color:#6b7280;margin-bottom:20px;">Mot de passe: <strong>solana123</strong></p>
    <input type="password" id="loginPassword" class="login-input" placeholder="Entrez solana123">
    <button class="login-btn" onclick="login()">üîì ACC√âDER AU DASHBOARD</button>
    <p style="font-size:0.9rem;color:#9ca3af;margin-top:15px;">‚òÅÔ∏è SUPABASE AUTO-SYNC MULTI-T√âL√âPHONES</p>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboardMain">
  <div class="header">
    <h1>üìä Suivi Chargements Solana France</h1>
    <p id="totalInfo">Chargement...</p>
    <button class="logout-btn" onclick="logout()">‚ùå D√©connexion</button>
  </div>

  <!-- STATUS SUPABASE -->
  <div id="supabaseStatus" class="supabase-status" style="display:none;">‚úÖ SUPABASE CONNECT√â ‚òÅÔ∏è</div>

  <!-- FORMULAIRE AJOUT -->
  <div class="add-section">
    <h2 style="color:#0077b6;margin-bottom:25px;">‚ûï Nouvelle Commande Export</h2>
    <form onsubmit="ajouterCmd(event)">
      <div class="form-group">
        <label>üë§ Client</label>
        <input id="clientIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üìÑ R√©f Commande</label>
        <input id="refIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üìÖ Date</label>
        <input id="dateIn" type="date" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üöö Point D√©part (76,62...)</label>
        <input id="pointDepart" class="form-input" placeholder="76,62,29,51..." required>
      </div>
      <div class="form-group">
        <label>üåç Pays Destination</label>
        <select id="paysIn" class="form-input" required>
          <option value="">S√©lectionner...</option>
        </select>
      </div>
      <div class="form-group">
        <label>‚öñÔ∏è Tonnes</label>
        <input id="tonnesIn" type="number" step="0.01" min="0.01" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üöõ Immatriculation</label>
        <input id="immatIn" class="form-input" placeholder="AB-123-CD">
      </div>
      <div class="form-group">
        <label>üìß Email Client</label>
        <input id="emailIn" type="email" class="form-input" required>
      </div>
      <button type="submit" class="add-btn">‚ûï AJOUTER & AUTO-SYNC ‚òÅÔ∏è</button>
    </form>
  </div>

  <!-- EXPORT & SYNC SECTION -->
  <div class="export-section">
    <button class="export-btn btn-excel" onclick="exportExcel()">
      üìä Excel <span id="excelCount">0</span> lignes
    </button>
    <button class="export-btn btn-sync" onclick="synchroniserSheets()" id="syncBtn">
      üîÑ SYNCHRO LIVE
    </button>
  </div>

  <!-- KPI GRID -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-value" id="totT">0 T</div>
      <div class="kpi-label">Total Tonnes</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚è≥</div>
      <div class="kpi-value" id="att">0</div>
      <div class="kpi-label">En Attente</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-value" id="cha">0</div>
      <div class="kpi-label">Charg√©es</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">üìß</div>
      <div class="kpi-value" id="em">0</div>
      <div class="kpi-label">Emails Envoy√©s</div>
    </div>
  </div>

  <!-- TOP CLIENTS -->
  <div class="graph-clients" id="topClientsSection">
    <h2 class="graph-title">üëë TOP 8 CLIENTS (Tonnes)</h2>
    <div id="graphClients">Chargement...</div>
  </div>

  <!-- üó∫Ô∏è CARTE SIMPLIFI√âE STYLE SHOPIFY -->
  <div class="map-section">
    <h2 class="graph-title">üó∫Ô∏è Destinations Export (Cliquez pour d√©tails)</h2>
    
    <!-- GRILLE PAYS -->
    <div class="map-grid" id="mapGrid">
      <div class="loading">Chargement destinations...</div>
    </div>
    
    <!-- D√âTAIL PAYS -->
    <div id="countryDetail" class="country-detail">
      <h3 id="detailTitle"></h3>
      <p id="detailStats"></p>
      <table class="detail-table" id="detailTable"></table>
      <button onclick="closeCountryDetail()" style="margin-top:15px;padding:10px 20px;background:#ef4444;color:white;border:none;border-radius:12px;cursor:pointer;font-weight:600;">‚úï Fermer</button>
    </div>
  </div>

  <!-- TABLEAU COMMANDES -->
  <div class="table-container">
    <h2 style="color:#0077b6;margin-bottom:25px;">üìã Liste des Commandes</h2>
    <table>
      <thead>
        <tr>
          <th>Client</th><th>R√©f</th><th>Date</th><th>D√©part</th><th>Pays</th><th>Tonnes</th><th>Immat</th><th>Statut</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tab">
        <tr><td colspan="9" class="loading">‚òÅÔ∏è Connexion Supabase...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // üî• SUPABASE 100% AUTO-CONFIGUR√â
  const SUPABASE_URL = 'https://sxmdaqcdlgxcykrbnvxg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4bWRhcWNkbGd4Y3lrcmJudnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjQwMjIsImV4cCI6MjA4NDc0MDAyMn0.N3wZiU6QDIYqkfCbsDoLaS7jXU7HCASQhwknqA-2rgQ'; 
  
  let cmds = [];

  // ‚úÖ SAVE CMD - AVEC DEBUG COMPLET
  async function saveCmd(cmd) {
    try {
      console.log('üîÑ Envoi Supabase:', cmd);
      const res = await fetch(`${SUPABASE_URL}/rest/v1/commandes`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify([cmd])
      });
      
      const errorText = await res.text();
      console.log('üì° R√©ponse Supabase:', res.status, errorText);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      console.log('‚úÖ INSERT OK');
      return true;
    } catch(e) {
      console.error('‚ùå ERREUR SAVE:', e);
      alert('‚ùå Erreur sauvegarde: ' + e.message);
      return false;
    }
  }

  // CHARGEMENT LIVE SUPABASE
  async function loadCmds() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/commandes?select=*&order=ref.desc`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      if (!res.ok) throw new Error('Erreur chargement Supabase');
      cmds = await res.json();
      console.log('üì¶ Commandes charg√©es:', cmds.length);
    } catch(e) {
      console.error('‚ùå Supabase load error:', e);
      document.getElementById('tab').innerHTML = `
        <tr><td colspan="9" class="error-message">
          ‚ùå Supabase d√©connect√©<br>
          V√©rifie ta cl√© anon/public<br>
          <button onclick="synchroniserSheets()" style="background:#10b981;color:white;padding:10px;border:none;border-radius:8px;cursor:pointer;">üîÑ RETRY</button>
        </td></tr>
      `;
    }
  }

  // AJOUT AUTO-SYNC SUPABASE
  async function ajouterCmd(e) {
    e.preventDefault();
    const n = {
      client: document.getElementById('clientIn').value.trim(),
      ref: document.getElementById('refIn').value.trim(),
      date: document.getElementById('dateIn').value,
      point_depart: document.getElementById('pointDepart').value.trim(),
      pays: document.getElementById('paysIn').value,
      tonnes: parseFloat(document.getElementById('tonnesIn').value),
      immat: document.getElementById('immatIn').value.trim(),
      email: document.getElementById('emailIn').value.trim(),
      statut: 'EN ATTENTE',
      nb_emails: 0,
      derniere_date_email: null
    };
    
    // V√©rif doublon
    if (cmds.find(c => c.ref === n.ref)) {
      alert('‚ö†Ô∏è R√©f√©rence DUPLIQU√âE !');
      return;
    }
    
    const saveOk = await saveCmd(n);
    if (saveOk) {
      await loadCmds();
      maj();
      e.target.reset();
      document.getElementById('dateIn').valueAsDate = new Date();
      alert('‚úÖ AJOUT√â & SYNC MULTI-T√âL√âPHONES ! ‚òÅÔ∏è');
    }
  }

  // SYNCHRO LIVE
  async function synchroniserSheets() {
    document.getElementById('tab').innerHTML = '<tr><td colspan="9" class="loading">‚òÅÔ∏è Synchronisation live...</td></tr>';
    await loadCmds();
    maj();
  }

  // ‚úÖ UPDATE CMD CORRIG√â
  async function updateCmd(ref, updates) {
    try {
      console.log('üîÑ Update:', ref, updates);
      const res = await fetch(`${SUPABASE_URL}/rest/v1/commandes?ref=eq.${ref}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(updates)
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      
      console.log('‚úÖ UPDATE OK');
      await loadCmds();
      maj();
    } catch(e) {
      console.error('‚ùå Update error:', e);
      alert('‚ùå Erreur mise √† jour: ' + e.message);
    }
  }

  // üåê UNIVERSEL MOBILE/PC + EMAIL AUTO
  async function confirmerEmail(ref) {
    const c = cmds.find(x => x.ref === ref);
    if (!c) return alert('‚ùå Commande introuvable');

    if (!confirm(`üöö ${c.client}\n${c.ref} - ${c.tonnes.toFixed(2)}T\n\nüìß Ouvrir email + notif ?`)) return;

    await updateCmd(ref, {
      nb_emails: (parseInt(c.nb_emails || 0) + 1),
      derniere_date_email: new Date().toLocaleDateString('fr-FR'),
      statut: 'CHARG√âE'
    });

    const sujet = `‚úÖ CHARG√âE - ${c.ref} - ${c.tonnes.toFixed(2)}T`;
    const message = `Bonjour ${c.client},

üéâ COMMANDE CHARG√âE ET PR√äTE √Ä PARTIR ! üéâ
üìã D√âTAILS DE VOTRE COMMANDE :
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
REF: ${c.ref}

Point d√©part: ${c.point_depart}
Destination: ${c.pays}
Tonnes: ${c.tonnes.toFixed(2)}T
Camion: ${c.immat || 'Non sp√©cifi√©'}
Email: ${c.email}

‚úÖ Statut: LIVRAISON CONFIRM√âE
üìß Cet email a √©t√© envoy√© automatiquement`;

    window.open(`mailto:${c.email}?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(message)}`, '_blank');

    setTimeout(() => notificationsUniverSel(c), 500);
  }

  // üî• NOTIFICATIONS UNIVERSELLES
  function notificationsUniverSel(c) {
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200]);
      document.title = `üöö ${c.ref} CHARG√âE !`;
      setTimeout(() => document.title = 'Solana Dashboard', 3000);
    }
    
    if (typeof Notification !== 'undefined') {
      if (Notification.permission === 'granted') {
        new Notification('üöö CHARGEMENT OK !', {
          body: `${c.client} - ${c.tonnes.toFixed(1)}T ‚Üí ${c.pays}`,
          icon: 'üöõ'
        });
      } else if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
    
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVKMbF1fdJivrJBhNjV');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    } catch(e) {}
  }

  // üó∫Ô∏è NOUVELLE CARTE SIMPLIFI√âE STYLE SHOPIFY
  const paysEmojis = {
    SN: 'üá∏üá≥', PT: 'üáµüáπ', MA: 'üá≤üá¶', FR: 'üá´üá∑', ES: 'üá™üá∏', 
    IT: 'üáÆüáπ', DE: 'üá©üá™', BE: 'üáßüá™', NL: 'üá≥üá±', TN: 'üáπüá≥',
    DZ: 'üá©üáø', GB: 'üá¨üáß', PL: 'üáµüá±', RO: 'üá∑üá¥', GR: 'üá¨üá∑'
  };

  function afficherCarteShopify() {
    const grid = document.getElementById('mapGrid');
    const paysTonnes = {};
    
    // Calcul stats par pays
    cmds.forEach(c => {
      paysTonnes[c.pays] = (paysTonnes[c.pays] || {tonnes: 0, cmds: 0, clients: new Set()});
      paysTonnes[c.pays].tonnes += c.tonnes;
      paysTonnes[c.pays].cmds++;
      paysTonnes[c.pays].clients.add(c.client);
    });
    
    if (Object.keys(paysTonnes).length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#9ca3af;">üåç Ajoutez des commandes pour voir les destinations</div>';
      return;
    }
    
    grid.innerHTML = Object.entries(paysTonnes).map(([code, stats]) => {
      const emoji = paysEmojis[code] || 'üåç';
      const totalTonnes = stats.tonnes.toFixed(1);
      return `
        <div class="map-card" onclick="showCountryDetail('${code}')" data-code="${code}">
          <div class="map-flag">${emoji} ${code}</div>
          <div class="map-tonnes">${totalTonnes}T</div>
          <div class="map-cmds">${stats.cmds} cmds ‚Ä¢ ${stats.clients.size} clients</div>
        </div>
      `;
    }).join('');
  }

  // D√âTAIL PAYS
  function showCountryDetail(code) {
    const paysCmds = cmds.filter(c => c.pays === code);
    const totalTonnes = paysCmds.reduce((s,c) => s + c.tonnes, 0);
    const emoji = paysEmojis[code] || 'üåç';
    
    document.getElementById('detailTitle').innerHTML = `${emoji} ${code} ‚Ä¢ ${totalTonnes.toFixed(1)}T export√©es`;
    document.getElementById('detailStats').innerHTML = `
      üì¶ ${paysCmds.length} commandes ‚Ä¢ 
      üë• ${new Set(paysCmds.map(c => c.client)).size} clients uniques
    `;
    
    const table = document.getElementById('detailTable');
    table.innerHTML = `
      <thead>
        <tr>
          <th>R√©f</th>
          <th>Client</th>
          <th>Date</th>
          <th>D√©part</th>
          <th>Tonnes</th>
          <th>Immat</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        ${paysCmds.slice(0, 10).map(c => `
          <tr>
            <td><b>${c.ref}</b></td>
            <td>${c.client}</td>
            <td>${c.date}</td>
            <td>${c.point_depart}</td>
            <td><b style="color:#10b981">${c.tonnes.toFixed(2)}T</b></td>
            <td>${c.immat || '-'}</td>
            <td style="color:${c.statut === 'CHARG√âE' ? '#10b981' : '#f59e0b'}">
              ${c.statut === 'CHARG√âE' ? '‚úÖ CHARG√âE' : '‚è≥ EN ATTENTE'}
            </td>
          </tr>
        `).join('')}
      </tbody>
    `;
    
    document.getElementById('countryDetail').classList.add('active');
    document.getElementById('countryDetail').scrollIntoView({behavior: 'smooth'});
  }

  function closeCountryDetail() {
    document.getElementById('countryDetail').classList.remove('active');
  }

  // SUPPRIMER
  async function supprimerCmd(ref) {
    const cmd = cmds.find(c => c.ref === ref);
    if (!confirm(`üóëÔ∏è SUPPRIMER ${cmd?.client || ''} (${ref}) ?`)) return;

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/commandes?ref=eq.${ref}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      await loadCmds();
      maj();
      alert('‚úÖ Supprim√© ! ‚òÅÔ∏è');
    } catch(e) {
      alert('‚ùå Erreur suppression: ' + e.message);
    }
  }

  // LOGIN + autres fonctions identiques...
  function login() {
    if (document.getElementById('loginPassword').value === 'solana123') {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardMain').style.display = 'block';
      testSupabase();
    } else {
      alert('‚ùå Mot de passe incorrect !\nüîë solana123');
      document.getElementById('loginPassword').value = '';
    }
  }

  function logout() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('dashboardMain').style.display = 'none';
    document.getElementById('loginPassword').value = '';
  }

  async function testSupabase() {
    try {
      await loadCmds();
      document.getElementById('supabaseStatus').style.display = 'block';
      maj();
    } catch(e) {
      document.getElementById('supabaseStatus').innerHTML = '‚ùå Supabase KO';
      document.getElementById('supabaseStatus').style.background = '#ef4444';
    }
  }

  // TOP CLIENTS (identique)
  function afficherTopClients() {
    const clients = {};
    cmds.forEach(c => clients[c.client] = (clients[c.client] || 0) + c.tonnes);
    const topClients = Object.entries(clients).sort((a,b) => b[1] - a[1]).slice(0, 8);
    
    if (topClients.length === 0) {
      document.getElementById('graphClients').innerHTML = '<div style="padding:40px;color:#9ca3af;">üìà Ajoutez des commandes</div>';
      return;
    }
    
    const totalTonnes = cmds.reduce((s,c) => s + c.tonnes, 0);
    const container = document.getElementById('graphClients');
    container.innerHTML = '';
    
    topClients.forEach(([client, tonnes], i) => {
      const pourcent = ((tonnes / totalTonnes) * 100).toFixed(1);
      const div = document.createElement('div');
      div.className = 'client-bar';
      div.innerHTML = `
        <div class="client-name">#${i+1} ${client.slice(0,15)}${client.length>15?'...':''}</div>
        <div class="client-tonnes">${tonnes.toFixed(1)}T</div>
        <div class="client-barre" style="width:${Math.min(pourcent*2.5,95)}%">
          <div class="client-pourcent">${pourcent}%</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // EXPORT EXCEL (identique)
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const ws_data = cmds.map(c => ({
      Client: c.client, 
      'R√©f': c.ref, 
      Date: c.date, 
      'Point d√©part': c.point_depart,
      Pays: c.pays, 
      Tonnes: c.tonnes, 
      Immatriculation: c.immat,
      Statut: c.statut, 
      'Nb Emails': c.nb_emails, 
      'Dernier email': c.derniere_date_email || ''
    }));
    const ws = XLSX.utils.json_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Solana_Export");
    XLSX.writeFile(wb, `Solana-Export-${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // MAJ COMPL√àTE
  function maj() {
    const tot = cmds.reduce((s,c) => s + c.tonnes, 0);
    const att = cmds.filter(c => c.statut === 'EN ATTENTE').length;
    const ch = cmds.filter(c => c.statut === 'CHARG√âE').length;
    const totalEmails = cmds.reduce((s,c) => s + (parseInt(c.nb_emails || 0)), 0);

    document.getElementById('totT').innerHTML = tot.toFixed(1) + ' T';
    document.getElementById('att').textContent = att;
    document.getElementById('cha').textContent = ch;
    document.getElementById('em').textContent = totalEmails;
    document.getElementById('totalInfo').innerHTML = `${cmds.length} commande(s) | ${new Date().toLocaleString('fr-FR')}`;
    document.getElementById('excelCount').textContent = cmds.length;

    const tb = document.getElementById('tab');
    if (cmds.length === 0) {
      tb.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;">üéØ Ajoutez votre 1√®re commande</td></tr>';
    } else {
      tb.innerHTML = cmds.map(c => {
        const statutText = c.statut === 'CHARG√âE' ? 
          `‚úÖ CHARG√âE (${c.nb_emails || 0}${c.derniere_date_email ? ` - ${c.derniere_date_email}` : ''})` : '‚è≥ EN ATTENTE';
        const btnConfirmer = c.statut === 'EN ATTENTE' ? 
          `<button class="action-btn btn-confirmer" onclick="confirmerEmail('${c.ref}')">‚úÖ CHARGER</button>` :
          `<button class="action-btn btn-resent" onclick="confirmerEmail('${c.ref}')">üìß RENV</button>`;
        
        return `
          <tr class="${c.statut === 'CHARG√âE' ? 'chargee' : ''}">
            <td><b>${c.client}</b></td>
            <td>${c.ref}</td>
            <td>${c.date}</td>
            <td>${c.point_depart}</td>
            <td>${c.pays}</td>
            <td><b style="color:#10b981">${c.tonnes.toFixed(2)}T</b></td>
            <td>${c.immat || '-'}</td>
            <td style="color:${c.statut === 'CHARG√âE' ? '#10b981' : '#f59e0b'}"><b>${statutText}</b></td>
            <td>${btnConfirmer} <button class="action-btn btn-supprimer" onclick="supprimerCmd('${c.ref}')">üóëÔ∏è</button></td>
          </tr>
        `;
      }).join('');
      
      notificationsUniverSel(cmds.find(c => c.statut === 'CHARG√âE'));
    }
    
    afficherTopClients();
    afficherCarteShopify(); // ‚úÖ NOUVEAU !
  }

  // INIT
  window.addEventListener('load', () => {
    document.getElementById('loginPassword').focus();
    
    const select = document.getElementById('paysIn');
    Object.keys(paysEmojis).sort().forEach(code => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = `${paysEmojis[code]} ${code}`;
      select.appendChild(option);
    });
    document.getElementById('dateIn').valueAsDate = new Date();
  });

  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
      login();
    }
  });  // Sans espaces avant !

</script>  <!-- FERME LE SCRIPT PRINCIPAL -->

<script type="module">
  import { polyfillCountryFlagEmojis } from "https://cdn.skypack.dev/country-flag-emoji-polyfill";
  polyfillCountryFlagEmojis();
</script>
</body>
</html>
