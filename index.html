<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöö Solana France - Dashboard Logistique PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif;}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#e2e8f0 100%);color:#1f2937;min-height:100vh;}
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#00b4d8,#0077b6);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .login-card{background:#fff;border-radius:24px;padding:50px 60px;box-shadow:0 30px 60px rgba(0,0,0,.3);max-width:450px;width:90%;text-align:center;}
    .login-card h1{font-size:2.5rem;color:#0077b6;margin-bottom:15px;}
    .login-input{width:100%;padding:18px;border:2px solid #e5e7eb;border-radius:16px;font-size:18px;margin:20px 0;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:all .3s;}
    .login-input:focus{border-color:#00b4d8;box-shadow:0 0 0 3px rgba(0,180,216,.2);}
    .login-btn{width:100%;padding:18px;background:#00b4d8;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(0,180,216,.4);transition:all .3s;}
    .login-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,180,216,.5);}
    .dashboard{display:none;padding:30px;max-width:1400px;margin:0 auto;}
    .header{position:relative;background:#fff;border-radius:24px 24px 0 0;padding:35px 40px;box-shadow:0 20px 40px rgba(0,0,0,.15);margin:-30px -30px 0;}
    .header h1{font-size:2.3rem;color:#0077b6;margin-bottom:10px;}
    .logout-btn{position:absolute;top:35px;right:40px;background:#ef4444;color:white;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 5px 15px rgba(239,68,68,.4);transition:all .3s;}
    .logout-btn:hover{transform:translateY(-2px);}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:25px;margin:35px 0;}
    .kpi-card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);text-align:center;transition:all .3s;cursor:pointer;}
    .kpi-card:hover{transform:translateY(-8px);box-shadow:0 25px 50px rgba(0,0,0,.2);}
    .kpi-icon{font-size:4rem;margin-bottom:15px;}
    .kpi-value{font-size:3rem;font-weight:800;color:#0077b6;margin-bottom:8px;}
    .kpi-label{font-size:1.1rem;color:#6b7280;font-weight:500;}
    .add-section{background:#fff;border-radius:20px;padding:35px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    .add-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
    .form-group label{font-weight:600;color:#374151;margin-bottom:8px;display:block;}
    .form-input{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .form-input:focus{border-color:#00b4d8;outline:none;box-shadow:0 0 0 3px rgba(0,180,216,.1);}
    .add-btn{grid-column:1/-1;padding:20px;background:#10b981;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(16,185,129,.4);transition:all .3s;}
    .add-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(16,185,129,.5);}
    .table-container{overflow-x:auto;background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    table{width:100%;border-collapse:collapse;}
    th{padding:20px 15px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);color:#374151;font-weight:700;font-size:1rem;border-bottom:4px solid #e5e7eb;}
    td{padding:18px 15px;border-bottom:2px solid #f3f4f6;vertical-align:middle;}
    tr:hover{background:#f8fafc;}
    tr.chargee{background:#f0fdf4;}
    .action-btn{min-width:100px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;margin:1px;font-size:.85rem;}
    .btn-confirmer{background:#10b981;color:white;box-shadow:0 4px 12px rgba(16,185,129,.4);}
    .btn-confirmer:hover{background:#059669;transform:translateY(-1px);}
    .btn-resent{background:#f59e0b;color:white;box-shadow:0 4px 12px rgba(245,158,11,.4);}
    .btn-resent:hover{background:#d97706;transform:translateY(-1px);}
    .btn-supprimer{background:#ef4444;color:white;box-shadow:0 4px 12px rgba(239,68,68,.4);}
    .btn-supprimer:hover{background:#dc2626;transform:translateY(-1px);}
    .graph-clients {background: #fff;border-radius: 20px;padding: 25px;box-shadow: 0 15px 35px rgba(0,0,0,.12);margin: 30px 0;}
    .graph-title {color: #0077b6;font-size: 1.5rem;margin-bottom: 20px;text-align: center;}
    .client-bar {display: flex;align-items: center;margin: 12px 0;background: #f1f5f9;border-radius: 12px;padding: 15px;transition: all .3s;}
    .client-bar:hover {transform: translateX(10px);box-shadow: 0 10px 25px rgba(0,180,216,.2);}
    .client-name {font-weight: 700;color: #374151;min-width: 120px;}
    .client-tonnes {font-weight: 800;color: #0077b6;margin-left: 20px;}
    .client-barre {flex: 1;height: 25px;background: linear-gradient(90deg, #10b981, #00b4d8);border-radius: 12px;margin: 0 20px;position: relative;overflow: hidden;}
    .client-pourcent {position: absolute;right: 10px;color: white;font-weight: 600;}
    .export-section {display: flex; gap: 15px; margin: 20px 0; padding: 20px;background: linear-gradient(135deg, #f0fdf4, #d1fae5);border-radius: 20px; border: 2px solid #10b981;}
    .export-btn {flex: 1; padding: 15px 20px; border: none; border-radius: 15px;font-weight: 700; font-size: 16px; cursor: pointer; transition: all .3s;display: flex; align-items: center; gap: 10px; justify-content: center;}
    .btn-excel { background: #059669; color: white; }
    .btn-excel:hover { background: #047857; transform: scale(1.05); }
    .btn-save { background: #8b5cf6; color: white; }
    .btn-save:hover { background: #7c3aed; transform: scale(1.05); }
    .btn-sync { background: #10b981; color: white; }
    .btn-sync:hover { background: #059669; transform: scale(1.05); }
    /* CARTE SIMPLE 2D */
    .map-section {background: #fff; border-radius: 20px; padding: 25px;box-shadow: 0 15px 35px rgba(0,0,0,.12); margin: 30px 0;text-align: center;}
    #mapCanvas {width: 100%; height: 450px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.2); cursor: pointer; background: #e0f2fe;}
    .country-info {margin-top: 20px; padding: 20px; background: #f0fdf4;border-radius: 15px; border-left: 5px solid #10b981;}
    .loading {color: #f59e0b; font-size: 1.2rem; padding: 40px; text-align: center;}
    .error-message {color: #dc2626; padding: 20px; background: #fef2f2; border-radius: 12px; margin: 20px 0; border-left: 5px solid #ef4444;}
    #saveStatus {font-size: 0.9rem; margin-left: 5px;}
    .supabase-status {background: #10b981;color:white;padding:10px;border-radius:12px;margin:10px 0;font-weight:600;}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1>üöö Solana Logistique PRO</h1>
    <p style="color:#6b7280;margin-bottom:20px;">Mot de passe: <strong>solana123</strong></p>
    <input type="password" id="loginPassword" class="login-input" placeholder="Entrez solana123">
    <button class="login-btn" onclick="login()">üîì ACC√âDER AU DASHBOARD</button>
    <p style="font-size:0.9rem;color:#9ca3af;margin-top:15px;">‚òÅÔ∏è SUPABASE AUTO-SYNC MULTI-T√âL√âPHONES</p>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboardMain">
  <div class="header">
    <h1>üìä Suivi Chargements Solana France</h1>
    <p id="totalInfo">Chargement...</p>
    <button class="logout-btn" onclick="logout()">‚ùå D√©connexion</button>
  </div>

  <!-- STATUS SUPABASE -->
  <div id="supabaseStatus" class="supabase-status" style="display:none;">‚úÖ SUPABASE CONNECT√â ‚òÅÔ∏è</div>

  <!-- FORMULAIRE AJOUT -->
  <div class="add-section">
    <h2 style="color:#0077b6;margin-bottom:25px;">‚ûï Nouvelle Commande Export</h2>
    <form onsubmit="ajouterCmd(event)">
      <div class="form-group">
        <label>üë§ Client</label>
        <input id="clientIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üìÑ R√©f Commande</label>
        <input id="refIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üìÖ Date</label>
        <input id="dateIn" type="date" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üöö Point D√©part (76,62...)</label>
        <input id="pointDepart" class="form-input" placeholder="76,62,29,51..." required>
      </div>
      <div class="form-group">
        <label>üåç Pays Destination</label>
        <select id="paysIn" class="form-input" required>
          <option value="">S√©lectionner...</option>
        </select>
      </div>
      <div class="form-group">
        <label>‚öñÔ∏è Tonnes</label>
        <input id="tonnesIn" type="number" step="0.01" min="0.01" class="form-input" required>
      </div>
      <div class="form-group">
        <label>üöõ Immatriculation</label>
        <input id="immatIn" class="form-input" placeholder="AB-123-CD">
      </div>
      <div class="form-group">
        <label>üìß Email Client</label>
        <input id="emailIn" type="email" class="form-input" required>
      </div>
      <button type="submit" class="add-btn">‚ûï AJOUTER & AUTO-SYNC ‚òÅÔ∏è</button>
    </form>
  </div>

  <!-- EXPORT & SYNC SECTION -->
  <div class="export-section">
    <button class="export-btn btn-excel" onclick="exportExcel()">
      üìä Excel <span id="excelCount">0</span> lignes
    </button>
    <button class="export-btn btn-sync" onclick="synchroniserSheets()" id="syncBtn">
      üîÑ SYNCHRO LIVE
    </button>
  </div>

  <!-- KPI GRID -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-value" id="totT">0 T</div>
      <div class="kpi-label">Total Tonnes</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚è≥</div>
      <div class="kpi-value" id="att">0</div>
      <div class="kpi-label">En Attente</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-value" id="cha">0</div>
      <div class="kpi-label">Charg√©es</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">üìß</div>
      <div class="kpi-value" id="em">0</div>
      <div class="kpi-label">Emails Envoy√©s</div>
    </div>
  </div>

  <!-- TOP CLIENTS -->
  <div class="graph-clients" id="topClientsSection">
    <h2 class="graph-title">üëë TOP 8 CLIENTS (Tonnes)</h2>
    <div id="graphClients">Chargement...</div>
  </div>

  <!-- CARTE 2D SIMPLE -->
  <div class="map-section">
    <h2 class="graph-title">üó∫Ô∏è Destinations Export</h2>
    <canvas id="mapCanvas"></canvas>
    <div class="country-info" id="countryInfo">
      <strong>üëÜ Cliquez sur les points pour voir les stats par pays</strong>
    </div>
  </div>

  <!-- TABLEAU COMMANDES -->
  <div class="table-container">
    <h2 style="color:#0077b6;margin-bottom:25px;">üìã Liste des Commandes</h2>
    <table>
      <thead>
        <tr>
          <th>Client</th><th>R√©f</th><th>Date</th><th>D√©part</th><th>Pays</th><th>Tonnes</th><th>Immat</th><th>Statut</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tab">
        <tr><td colspan="9" class="loading">‚òÅÔ∏è Connexion Supabase...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // üî• SUPABASE 100% AUTO-CONFIGUR√â
  const SUPABASE_URL = 'https://sxmdaqcdlgxcykrbnvxg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4bWRhcWNkbGd4Y3lrcmJudnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjQwMjIsImV4cCI6MjA4NDc0MDAyMn0.N3wZiU6QDIYqkfCbsDoLaS7jXU7HCASQhwknqA-2rgQ'; 
  
  let cmds = [];

  // ‚úÖ BUG 1 FIX√â - saveCmd() avec debug complet
  async function saveCmd(cmd) {
    try {
      console.log('Envoi:', cmd);  // DEBUG
      const res = await fetch(`${SUPABASE_URL}/rest/v1/commandes`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify([cmd])
      });
      const errorText = await res.text();
      console.log('R√©ponse Supabase:', res.status, errorText);  // DEBUG
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      console.log('‚úÖ INSERT OK');
    } catch(e) {
      console.error('ERREUR D√âTAILL√âE:', e);
      alert('‚ùå HTTP ' + e.message);
    }
  }

  // CHARGEMENT LIVE SUPABASE
  async function loadCmds() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/commandes?select=*&order=ref.desc`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      if (!res.ok) throw new Error('Erreur chargement');
      cmds = await res.json();
    } catch(e) {
      console.error('Supabase error:', e);
      document.getElementById('tab').innerHTML = `
        <tr><td colspan="9" class="error-message">
          ‚ùå Supabase d√©connect√©<br>
          V√©rifie ta cl√© anon/public<br>
          <button onclick="synchroniserSheets()" style="background:#10b981;color:white;padding:10px;border:none;border-radius:8px;cursor:pointer;">üîÑ RETRY</button>
        </td></tr>
      `;
    }
  }

  // AJOUT AUTO-SYNC SUPABASE
  async function ajouterCmd(e) {
    e.preventDefault();
    const n = {
      client: document.getElementById('clientIn').value.trim(),
      ref: document.getElementById('refIn').value.trim(),
      date: document.getElementById('dateIn').value,
      point_depart: document.getElementById('pointDepart').value.trim(),
      pays: document.getElementById('paysIn').value,
      tonnes: parseFloat(document.getElementById('tonnesIn').value),
      immat: document.getElementById('immatIn').value.trim(),
      email: document.getElementById('emailIn').value.trim(),
      statut: 'EN ATTENTE',
      nb_emails: 0,
      derniere_date_email: null
    };
    
    if (cmds.find(c => c.ref === n.ref)) {
      alert('‚ö†Ô∏è R√©f√©rence DUPLIQU√âE !');
      return;
    }
    
    await saveCmd(n);
    await loadCmds();
    maj();
    e.target.reset();
    document.getElementById('dateIn').valueAsDate = new Date();
    alert('‚úÖ AUTO-SYNC MULTI-T√âL√âPHONES ! ‚òÅÔ∏è');
  }

  // SYNCHRO = Refresh live Supabase
  async function synchroniserSheets() {
    document.getElementById('tab').innerHTML = '<tr><td colspan="9" class="loading">‚òÅÔ∏è Live sync Supabase...</td></tr>';
    await loadCmds();
    maj();
  }

  // ‚úÖ BUG 2 FIX√â - updateCmd avec array + ref
  async function updateCmd(ref, updates) {
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/commandes?ref=eq.${ref}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify([{ref: ref, ...updates}])
      });
      await loadCmds();
    } catch(e) {
      alert('‚ùå Erreur update: ' + e.message);
    }
  }

  // LOGIN
  function login() {
    if (document.getElementById('loginPassword').value === 'solana123') {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardMain').style.display = 'block';
      testSupabase();
    } else {
      alert('‚ùå Mot de passe incorrect !\nüîë solana123');
      document.getElementById('loginPassword').value = '';
    }
  }

  function logout() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('dashboardMain').style.display = 'none';
    document.getElementById('loginPassword').value = '';
  }

  // TEST SUPABASE
  async function testSupabase() {
    try {
      await loadCmds();
      document.getElementById('supabaseStatus').style.display = 'block';
      maj();
    } catch(e) {
      document.getElementById('supabaseStatus').innerHTML = '‚ùå Supabase KO - V√©rifie ta cl√©';
      document.getElementById('supabaseStatus').style.background = '#ef4444';
    }
  }

  // ‚úÖ BUG 2 FIX√â - confirmerEmail() avec bons noms de colonnes
  function confirmerEmail(ref) {
    const c = cmds.find(x => x.ref === ref);
    if (!confirm(`üìß ${c.client} ?\n${c.ref} - ${c.tonnes.toFixed(2)}T`)) return;
    
    updateCmd(ref, {
      nb_emails: (c.nb_emails || 0) + 1,
      derniere_date_email: new Date().toLocaleDateString('fr-FR'),
      statut: 'CHARG√âE'
    });
  }

  // SUPPRIMER
  async function supprimerCmd(ref) {
    if (confirm(`üóëÔ∏è SUPPRIMER ${cmds.find(c => c.ref === ref)?.client} (${ref}) ?`)) {
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/commandes?ref=eq.${ref}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });
        await loadCmds();
        maj();
        alert('‚úÖ Supprim√© ! ‚òÅÔ∏è');
      } catch(e) {
        alert('‚ùå Erreur suppression');
      }
    }
  }

  // TOP CLIENTS
  function afficherTopClients() {
    const clients = {};
    cmds.forEach(c => clients[c.client] = (clients[c.client] || 0) + c.tonnes);
    const topClients = Object.entries(clients).sort((a,b) => b[1] - a[1]).slice(0, 8);
    
    if (topClients.length === 0) {
      document.getElementById('graphClients').innerHTML = '<div style="padding:40px;color:#9ca3af;">üìà Ajoutez des commandes</div>';
      return;
    }
    
    const totalTonnes = cmds.reduce((s,c) => s + c.tonnes, 0);
    const container = document.getElementById('graphClients');
    container.innerHTML = '';
    
    topClients.forEach(([client, tonnes], i) => {
      const pourcent = ((tonnes / totalTonnes) * 100).toFixed(1);
      const div = document.createElement('div');
      div.className = 'client-bar';
      div.innerHTML = `
        <div class="client-name">#${i+1} ${client.slice(0,15)}${client.length>15?'...':''}</div>
        <div class="client-tonnes">${tonnes.toFixed(1)}T</div>
        <div class="client-barre" style="width:${Math.min(pourcent*2.5,95)}%">
          <div class="client-pourcent">${pourcent}%</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // CARTE 2D (IDENTIQUE)
  const paysPositions = {
    SN: {x: 450, y: 220, name: 'S√©n√©gal', color: '#ec4899'},
    PT: {x: 150, y: 280, name: 'Portugal', color: '#10b981'},
    MA: {x: 350, y: 320, name: 'Maroc', color: '#f59e0b'},
    FR: {x: 250, y: 250, name: 'France', color: '#0077b6'},
    ES: {x: 200, y: 270, name: 'Espagne', color: '#ef4444'},
    IT: {x: 320, y: 260, name: 'Italie', color: '#8b5cf6'},
    DE: {x: 300, y: 200, name: 'Allemagne', color: '#06b6d4'},
    BE: {x: 280, y: 220, name: 'Belgique', color: '#10b981'},
    NL: {x: 290, y: 190, name: 'Pays-Bas', color: '#f59e0b'},
    TN: {x: 420, y: 280, name: 'Tunisie', color: '#14b8a6'},
    DZ: {x: 380, y: 290, name: 'Alg√©rie', color: '#f97316'},
    GB: {x: 220, y: 170, name: 'Royaume-Uni', color: '#3b82f6'},
    PL: {x: 380, y: 150, name: 'Pologne', color: '#ef4444'},
    RO: {x: 420, y: 190, name: 'Roumanie', color: '#f59e0b'},
    GR: {x: 450, y: 260, name: 'Gr√®ce', color: '#10b981'}
  };

  function initMapCanvas() {
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      renderMap();
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    canvas.onclick = function(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      for (const [code, pos] of Object.entries(paysPositions)) {
        const dist = Math.sqrt((x - pos.x * canvas.width/800)**2 + (y - pos.y * canvas.height/500)**2);
        if (dist < 25) {
          showCountryInfo(code);
          return;
        }
      }
    };
    
    function renderMap() {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      
      const gradient = ctx.createLinearGradient(0, 0, 0, h);
      gradient.addColorStop(0, '#e0f2fe');
      gradient.addColorStop(1, '#bae6fd');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, w, h);
      
      ctx.fillStyle = '#a8ddb5';
      ctx.fillRect(w*0.1, h*0.4, w*0.15, h*0.25);
      ctx.fillRect(w*0.3, h*0.35, w*0.12, h*0.18);
      ctx.fillRect(w*0.5, h*0.45, w*0.12, h*0.2);
      
      const paysTonnes = {};
      cmds.forEach(c => paysTonnes[c.pays] = (paysTonnes[c.pays] || 0) + c.tonnes);
      
      Object.entries(paysTonnes).forEach(([code, tonnes]) => {
        if (paysPositions[code]) {
          const pos = paysPositions[code];
          const scaleX = w / 800, scaleY = h / 500;
          const x = pos.x * scaleX, y = pos.y * scaleY;
          const size = Math.max(12, tonnes * 4);
          
          ctx.fillStyle = paysPositions[code].color;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI*2);
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          ctx.fillStyle = '#fff';
          ctx.font = `${Math.max(12, size/1.5)}px bold Arial`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(code, x, y);
        }
      });
      
      requestAnimationFrame(renderMap);
    }
    
    function showCountryInfo(code) {
      const pos = paysPositions[code];
      const paysCmds = cmds.filter(c => c.pays === code);
      const totalTonnes = paysCmds.reduce((s,c) => s + c.tonnes, 0);
      const clientsUniques = [...new Set(paysCmds.map(c => c.client))];
      
      document.getElementById('countryInfo').innerHTML = `
        <h3 style="color:${pos.color}">üåç ${pos.name} (${code})</h3>
        <p><strong>‚öñÔ∏è ${totalTonnes.toFixed(1)}T</strong> export√©es</p>
        <p>üë• ${clientsUniques.length} clients</p>
        <p>üì¶ ${paysCmds.length} commandes</p>
      `;
    }
  }

  // EXPORT EXCEL ‚úÖ FIX√â noms colonnes
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const ws_data = cmds.map(c => ({
      Client: c.client, 'R√©f': c.ref, Date: c.date, 'Point d√©part': c.point_depart,
      Pays: c.pays, Tonnes: c.tonnes, Immatriculation: c.immat,
      Statut: c.statut, 'Nb Emails': c.nb_emails, 'Dernier email': c.derniere_date_email || ''
    }));
    const ws = XLSX.utils.json_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Solana_Export");
    XLSX.writeFile(wb, `Solana-Export-${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // ‚úÖ BUG 2 FIX√â - maj() avec nb_emails + table HTML corrig√©e
  function maj() {
    const tot = cmds.reduce((s,c) => s + c.tonnes, 0);
    const att = cmds.filter(c => c.statut === 'EN ATTENTE').length;
    const ch = cmds.filter(c => c.statut === 'CHARG√âE').length;
    const totalEmails = cmds.reduce((s,c) => s + (c.nb_emails || 0), 0);

    document.getElementById('totT').innerHTML = tot.toFixed(1) + ' T';
    document.getElementById('att').textContent = att;
    document.getElementById('cha').textContent = ch;
    document.getElementById('em').textContent = totalEmails;
    document.getElementById('totalInfo').innerHTML = `${cmds.length} commande(s) | ${new Date().toLocaleString('fr-FR')}`;
    document.getElementById('excelCount').textContent = cmds.length;

    const tb = document.getElementById('tab');
    if (cmds.length === 0) {
      tb.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;">üéØ Ajoutez votre 1√®re commande</td></tr>';
    } else {
      tb.innerHTML = cmds.map(c => {
        const statutText = c.statut === 'CHARG√âE' ? 
          `‚úÖ CHARG√âE (${c.nb_emails}${c.derniere_date_email ? ` - ${c.derniere_date_email}` : ''})` : '‚è≥ EN ATTENTE';
        const btnConfirmer = c.statut === 'EN ATTENTE' ? 
          `<button class="action-btn btn-confirmer" onclick="confirmerEmail('${c.ref}')">‚úÖ CHARGER</button>` :
          `<button class="action-btn btn-resent" onclick="confirmerEmail('${c.ref}')">üìß RENV</button>`;
        
        return `
          <tr class="${c.statut === 'CHARG√âE' ? 'chargee' : ''}">
            <td><b>${c.client}</b></td>
            <td>${c.ref}</td>
            <td>${c.date}</td>
            <td>${c.point_depart}</td>
            <td>${c.pays}</td>
            <td><b style="color:#10b981">${c.tonnes.toFixed(2)}T</b></td>
            <td>${c.immat || '-'}</td>
            <td style="color:${c.statut === 'CHARG√âE' ? '#10b981' : '#f59e0b'}"><b>${statutText}</b></td>
            <td>${btnConfirmer} <button class="action-btn btn-supprimer" onclick="supprimerCmd('${c.ref}')">üóëÔ∏è</button></td>
          </tr>
        `;
      }).join('');
    }
    
    afficherTopClients();
  }

  // INIT
  window.addEventListener('load', () => {
    initMapCanvas();
    document.getElementById('loginPassword').focus();
    
    const select = document.getElementById('paysIn');
    Object.entries(paysPositions).sort((a,b) => a[1].name.localeCompare(b[1].name))
      .forEach(([code, data]) => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = `${data.name} (${code})`;
        select.appendChild(option);
      });
    document.getElementById('dateIn').valueAsDate = new Date();
  });

  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
      login();
    }
  });
</script>
</body>
</html>


