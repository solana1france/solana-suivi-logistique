<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöö Solana France - Dashboard Logistique PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif;}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#e2e8f0 100%);color:#1f2937;min-height:100vh;}
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#00b4d8,#0077b6);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .login-card{background:#fff;border-radius:24px;padding:50px 60px;box-shadow:0 30px 60px rgba(0,0,0,.3);max-width:450px;width:90%;text-align:center;}
    .login-card h1{font-size:2.5rem;color:#0077b6;margin-bottom:15px;}
    .login-input{width:100%;padding:18px;border:2px solid #e5e7eb;border-radius:16px;font-size:18px;margin:20px 0;box-shadow:0 4px 12px rgba(0,0,0,.1);}
    .login-btn{width:100%;padding:18px;background:#00b4d8;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(0,180,216,.4);transition:all .3s;}
    .login-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,180,216,.5);}
    .dashboard{display:none;padding:30px;max-width:1400px;margin:0 auto;}
    .header{position:relative;background:#fff;border-radius:24px 24px 0 0;padding:35px 40px;box-shadow:0 20px 40px rgba(0,0,0,.15);margin:-30px -30px 0;}
    .header h1{font-size:2.3rem;color:#0077b6;margin-bottom:10px;}
    .logout-btn{position:absolute;top:35px;right:40px;background:#ef4444;color:white;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 5px 15px rgba(239,68,68,.4);}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:25px;margin:35px 0;}
    .kpi-card{background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);text-align:center;transition:all .3s;cursor:pointer;}
    .kpi-card:hover{transform:translateY(-8px);box-shadow:0 25px 50px rgba(0,0,0,.2);}
    .kpi-icon{font-size:4rem;margin-bottom:15px;}
    .kpi-value{font-size:3rem;font-weight:800;color:#0077b6;margin-bottom:8px;}
    .kpi-label{font-size:1.1rem;color:#6b7280;font-weight:500;}
    .add-section{background:#fff;border-radius:20px;padding:35px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    .add-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
    .form-group label{font-weight:600;color:#374151;margin-bottom:8px;display:block;}
    .form-input{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;transition:border .3s;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .form-input:focus{border-color:#00b4d8;outline:none;box-shadow:0 0 0 3px rgba(0,180,216,.1);}
    .add-btn{grid-column:1/-1;padding:20px;background:#10b981;color:white;border:none;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(16,185,129,.4);transition:all .3s;}
    .add-btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(16,185,129,.5);}
    .table-container{overflow-x:auto;background:#fff;border-radius:20px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.12);margin:30px 0;}
    table{width:100%;border-collapse:collapse;}
    th{padding:20px 15px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);color:#374151;font-weight:700;font-size:1rem;border-bottom:4px solid #e5e7eb;}
    td{padding:18px 15px;border-bottom:2px solid #f3f4f6;vertical-align:middle;}
    tr:hover{background:#f8fafc;}
    tr.chargee{background:#f0fdf4;}
    .action-btn{min-width:100px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;margin:1px;font-size:.85rem;}
    .btn-confirmer{background:#10b981;color:white;box-shadow:0 4px 12px rgba(16,185,129,.4);}
    .btn-confirmer:hover{background:#059669;transform:translateY(-1px);}
    .btn-resent{background:#f59e0b;color:white;box-shadow:0 4px 12px rgba(245,158,11,.4);}
    .btn-resent:hover{background:#d97706;transform:translateY(-1px);}
    .btn-supprimer{background:#ef4444;color:white;box-shadow:0 4px 12px rgba(239,68,68,.4);}
    .btn-supprimer:hover{background:#dc2626;transform:translateY(-1px);}

    /* ‚úÖ GRAPHIQUES TOP CLIENTS */
    .graph-clients {background: #fff;border-radius: 20px;padding: 25px;box-shadow: 0 15px 35px rgba(0,0,0,.12);margin: 30px 0;}
    .graph-title {color: #0077b6;font-size: 1.5rem;margin-bottom: 20px;text-align: center;}
    .client-bar {display: flex;align-items: center;margin: 12px 0;background: #f1f5f9;border-radius: 12px;padding: 15px;transition: all .3s;}
    .client-bar:hover {transform: translateX(10px);box-shadow: 0 10px 25px rgba(0,180,216,.2);}
    .client-name {font-weight: 700;color: #374151;min-width: 120px;}
    .client-tonnes {font-weight: 800;color: #0077b6;margin-left: 20px;}
    .client-barre {flex: 1;height: 25px;background: linear-gradient(90deg, #10b981, #00b4d8);border-radius: 12px;margin: 0 20px;position: relative;overflow: hidden;}
    .client-pourcent {position: absolute;right: 10px;color: white;font-weight: 600;}

    /* ‚úÖ EXPORT BUTTONS */
    .export-section {
      display: flex; gap: 15px; margin: 20px 0; padding: 20px;
      background: linear-gradient(135deg, #f0fdf4, #d1fae5);
      border-radius: 20px; border: 2px solid #10b981;
    }
    .export-btn {
      flex: 1; padding: 15px 20px; border: none; border-radius: 15px;
      font-weight: 700; font-size: 16px; cursor: pointer; transition: all .3s;
      display: flex; align-items: center; gap: 10px; justify-content: center;
    }
    .btn-pdf { background: #dc2626; color: white; }
    .btn-pdf:hover { background: #b91c1c; transform: scale(1.05); }
    .btn-excel { background: #059669; color: white; }
    .btn-excel:hover { background: #047857; transform: scale(1.05); }
    
    /* ‚úÖ GLOBE 3D */
    .globe-section {
      background: #fff; border-radius: 20px; padding: 25px;
      box-shadow: 0 15px 35px rgba(0,0,0,.12); margin: 30px 0;
      text-align: center;
    }
    .globe-container {
      position: relative; width: 100%; max-width: 500px; margin: 0 auto;
      height: 400px; perspective: 1000px;
    }
    .globe {
      width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
      transition: transform 0.5s; cursor: grab;
    }
    .globe:active { cursor: grabbing; }
    .globe:hover { transform: rotateY(10deg) rotateX(5deg); }
    .country {
      position: absolute; border-radius: 50%; cursor: pointer;
      transition: all 0.3s; font-weight: bold; color: white; text-shadow: 1px 1px 2px black;
    }
    .country:hover {
      transform: scale(1.3) translateZ(20px); box-shadow: 0 10px 30px rgba(0,180,216,.6);
      z-index: 10;
    }
    .country.active { 
      animation: pulse 2s infinite; box-shadow: 0 0 30px #10b981;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1.3) translateZ(20px); }
      50% { transform: scale(1.5) translateZ(30px); }
    }
    .country-info {
      margin-top: 20px; padding: 20px; background: #f0fdf4;
      border-radius: 15px; border-left: 5px solid #10b981;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1>üöö Solana Logistique</h1>
    <p>Mot de passe: <strong>solana123</strong></p>
    <input type="password" id="loginPassword" class="login-input" placeholder="solana123">
    <button class="login-btn" onclick="login()">üîì ACC√âDER</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboardMain">
  <div class="header">
    <h1>üìä Suivi Chargements Solana</h1>
    <p id="totalInfo">0 commandes | <span id="time"></span></p>
    <button class="logout-btn" onclick="logout()">‚ùå Sortie</button>
  </div>

  <!-- FORMULAIRE -->
  <div class="add-section">
    <h2 style="color:#0077b6;">‚ûï Nouvelle commande</h2>
    <form onsubmit="ajouterCmd(event)">
      <div class="form-group">
        <label>Client</label>
        <input id="clientIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>R√©f commande</label>
        <input id="refIn" class="form-input" required>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input id="dateIn" type="date" class="form-input" required>
      </div>
      <div class="form-group">
        <label>Point d√©part</label>
        <input id="pointDepart" class="form-input" placeholder="76,62,29..." required>
      </div>
      <div class="form-group">
        <label>Pays</label>
        <select id="paysIn" class="form-input">
          <!-- Pays g√©n√©r√©s par JS -->
        </select>
      </div>
      <div class="form-group">
        <label>Tonnes</label>
        <input id="tonnesIn" type="number" step="0.01" class="form-input" required>
      </div>
      <div class="form-group">
        <label>Immatriculation</label>
        <input id="immatIn" class="form-input" placeholder="AB-123-CD">
      </div>
      <div class="form-group">
        <label>Email client</label>
        <input id="emailIn" type="email" class="form-input" required>
      </div>
      <button type="submit" class="add-btn">‚ûï AJOUTER</button>
    </form>
  </div>

  <!-- ‚úÖ EXPORT BUTTONS -->
  <div class="export-section">
    <button class="export-btn btn-pdf" onclick="exportPDF()">
      üìÑ PDF Rapport <span id="pdfSize">0T</span>
    </button>
    <button class="export-btn btn-excel" onclick="exportExcel()">
      üìä Excel Donn√©es <span id="excelCount">0</span> lignes
    </button>
  </div>

  <!-- KPI -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-value" id="totT">0 T</div>
      <div>Total tonnes</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚è≥</div>
      <div class="kpi-value" id="att">0</div>
      <div>En attente</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-value" id="cha">0</div>
      <div>Charg√©es</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">üìß</div>
      <div class="kpi-value" id="em">0</div>
      <div>Emails envoy√©s</div>
    </div>
  </div>

  <!-- ‚úÖ GRAPHE TOP CLIENTS -->
  <div class="graph-clients" id="topClientsSection">
    <h2 class="graph-title">üëë TOP 8 CLIENTS</h2>
    <div id="graphClients"></div>
  </div>

  <!-- ‚úÖ GLOBE 3D -->
  <div class="globe-section">
    <h2 class="graph-title">üåç Destinations Export Solana</h2>
    <div class="globe-container" id="globeContainer">
      <div class="globe" id="globe" onmousedown="rotateGlobe(event)">
        <!-- Pays g√©n√©r√©s par JS -->
      </div>
    </div>
    <div class="country-info" id="countryInfo">
      <strong>S√©lectionnez un pays sur la carte</strong>
    </div>
  </div>

  <!-- TABLEAU -->
  <div class="table-container">
    <h2 style="color:#0077b6;">üìã Commandes</h2>
    <table>
      <thead>
        <tr>
          <th>Client</th><th>R√©f</th><th>Date</th><th>Point d√©part</th><th>Pays</th><th>T</th><th>Immat</th><th>Statut</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tab"></tbody>
    </table>
  </div>
</div>

<script>
// DATA PERSISTANTE
let cmds = JSON.parse(localStorage.getItem('solanaCmds')) || [];

// ‚úÖ DONN√âES PAYS GLOBE (+50 pays export agro)
const paysData = {
  PT: {name: 'Portugal', lat: 38.7, lng: -9.1, color: '#10b981', tonnes: 0},
  MA: {name: 'Maroc', lat: 31.8, lng: -7.1, color: '#f59e0b', tonnes: 0},
  FR: {name: 'France', lat: 46.2, lng: 2.2, color: '#0077b6', tonnes: 0},
  ES: {name: 'Espagne', lat: 40.5, lng: -3.7, color: '#ef4444', tonnes: 0},
  IT: {name: 'Italie', lat: 41.9, lng: 12.6, color: '#8b5cf6', tonnes: 0},
  DE: {name: 'Allemagne', lat: 51.2, lng: 10.4, color: '#06b6d4', tonnes: 0},
  BE: {name: 'Belgique', lat: 50.5, lng: 4.5, color: '#10b981', tonnes: 0},
  NL: {name: 'Pays-Bas', lat: 52.4, lng: 4.9, color: '#f59e0b', tonnes: 0},
  SN: {name: 'S√©n√©gal', lat: 14.0, lng: -14.0, color: '#ec4899', tonnes: 0},
  TN: {name: 'Tunisie', lat: 34.0, lng: 9.0, color: '#14b8a6', tonnes: 0},
  DZ: {name: 'Alg√©rie', lat: 28.0, lng: 1.7, color: '#f97316', tonnes: 0},
  GB: {name: 'Royaume-Uni', lat: 55.4, lng: -4.4, color: '#3b82f6', tonnes: 0},
  PL: {name: 'Pologne', lat: 51.9, lng: 19.4, color: '#ef4444', tonnes: 0},
  RO: {name: 'Roumanie', lat: 45.9, lng: 24.9, color: '#f59e0b', tonnes: 0},
  GR: {name: 'Gr√®ce', lat: 39.1, lng: 21.8, color: '#10b981', tonnes: 0}
};

// GLOBE ROTATION
let globeRotation = { x: 0, y: 0 }, isDragging = false;

// SUPPRIMER UNE COMMANDE
function supprimerCmd(refASupprimer) {
  const index = cmds.findIndex(cmd => cmd.ref === refASupprimer);
  if (index !== -1) {
    const c = cmds[index];
    if (confirm(`üóëÔ∏è SUPPRIMER SEULEMENT cette commande ?\n\nüë§ ${c.client}\nüìÑ R√©f: ${c.ref}\n‚öñÔ∏è ${c.tonnes.toFixed(2)}T\nüìß ${c.email}\n\nOK pour supprimer UNIQUEMENT cette ligne ?`)) {
      cmds.splice(index, 1);
      localStorage.setItem('solanaCmds', JSON.stringify(cmds));
      maj();
      alert(`‚úÖ Commande ${refASupprimer} supprim√©e !\nIl reste ${cmds.length} commande(s).`);
    }
  } else {
    alert('‚ùå Commande non trouv√©e !');
  }
}

// GRAPHE TOP CLIENTS
function afficherTopClients() {
  const clients = {};
  cmds.forEach(c => {
    clients[c.client] = (clients[c.client] || 0) + c.tonnes;
  });
  const topClients = Object.entries(clients).sort((a,b) => b[1] - a[1]).slice(0, 8);
  const container = document.getElementById('graphClients');
  container.innerHTML = '';
  const totalTonnes = cmds.reduce((s,c) => s + c.tonnes, 0);
  
  topClients.forEach(([client, tonnes], index) => {
    const pourcent = ((tonnes / totalTonnes) * 100).toFixed(1);
    const div = document.createElement('div');
    div.className = 'client-bar';
    div.innerHTML = `
      <div class="client-name">#${index+1} ${client.slice(0,15)}${client.length>15?'...':''}</div>
      <div class="client-tonnes">${tonnes.toFixed(1)} T</div>
      <div class="client-barre" style="width: ${Math.min(pourcent*2, 90)}%">
        <div class="client-pourcent">${pourcent}%</div>
      </div>
    `;
    container.appendChild(div);
  });
}

// LOGIN
function login() {
  if (document.getElementById('loginPassword').value === 'solana123') {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboardMain').style.display = 'block';
    maj();
  } else {
    alert('‚ùå Mot de passe: solana123');
  }
}

function logout() {
  localStorage.setItem('solanaCmds', JSON.stringify(cmds));
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('dashboardMain').style.display = 'none';
  document.getElementById('loginPassword').value = '';
}

// AJOUT COMMANDE
function ajouterCmd(e) {
  e.preventDefault();
  const n = {
    client: document.getElementById('clientIn').value,
    ref: document.getElementById('refIn').value,
    date: document.getElementById('dateIn').value,
    pointDepart: document.getElementById('pointDepart').value,
    pays: document.getElementById('paysIn').value,
    tonnes: parseFloat(document.getElementById('tonnesIn').value),
    immat: document.getElementById('immatIn').value,
    email: document.getElementById('emailIn').value,
    statut: 'EN ATTENTE',
    nbEmails: 0,
    derniereDateEmail: null
  };
  cmds.unshift(n);
  localStorage.setItem('solanaCmds', JSON.stringify(cmds));
  e.target.reset();
  maj();
}

// CONFIRMER & ENVOYER EMAIL
function confirmerEmail(ref) {
  const c = cmds.find(x => x.ref === ref);
  if (!confirm(`‚úÖ Confirmer l'envoi pour ${c.client} ?\n\nR√©f: ${c.ref}\nEmail: ${c.email}`)) {
    return;
  }
  c.nbEmails++;
  c.derniereDateEmail = new Date().toLocaleDateString('fr-FR');
  c.statut = 'CHARG√âE';
  const envoiNum = c.nbEmails;
  const sujet = `‚úÖ ${c.ref.toUpperCase()} ${envoiNum === 1 ? 'CHARG√âE' : 'RENVOY√âE'} - Solana France`;
  const msg = `${c.client},

Commande ${c.ref} ${envoiNum === 1 ? 'CHARG√âE' : 'RENVOY√âE'}!

D√âTAILS:
‚Ä¢ R√©f: ${c.ref}
‚Ä¢ Tonnes: ${c.tonnes}T
‚Ä¢ Point d√©part: ${c.pointDepart}
‚Ä¢ Immatriculation: ${c.immat}
‚Ä¢ Pays: ${c.pays}
‚Ä¢ Date: ${new Date().toLocaleDateString('fr-FR')}

${envoiNum > 1 ? `üìß ${envoiNum}√®me envoi.` : ''}`;

  const mailtoLink = `mailto:${encodeURIComponent(c.email)}?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(msg)}`;
  window.open(mailtoLink, '_blank');
  localStorage.setItem('solanaCmds', JSON.stringify(cmds));
  maj();
  alert('‚úÖ Email ouvert ! V√©rifiez votre client mail.');
}

// ‚úÖ EXPORT PDF
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Header
  doc.setFontSize(20);
  doc.text('üöö Solana France - Rapport Logistique', 20, 20);
  doc.setFontSize(12);
  doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 20, 35);
  doc.text(`Total: ${document.getElementById('totT').textContent}`, 20, 45);
  
  // KPI
  doc.text('üìä KPI', 20, 65);
  doc.text(`En attente: ${document.getElementById('att').textContent}`, 30, 75);
  doc.text(`Charg√©es: ${document.getElementById('cha').textContent}`, 30, 85);
  
  // Top Clients (canvas)
  const clientsCanvas = await html2canvas(document.getElementById('topClientsSection'));
  const imgData = clientsCanvas.toDataURL('image/png');
  doc.addImage(imgData, 'PNG', 20, 100, 170, 120);
  
  doc.save(`Solana-Rapport-${new Date().toISOString().slice(0,10)}.pdf`);
}

// ‚úÖ EXPORT EXCEL (CSV)
function exportExcel() {
  let csv = 'Client,R√©f,Date,Point d√©part,Pays,Tonnes,Immat,Statut,Emails\n';
  cmds.forEach(c => {
    csv += `"${c.client}","${c.ref}","${c.date}","${c.pointDepart}","${c.pays}",${c.tonnes},"${c.immat}","${c.statut}",${c.nbEmails}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Solana-Donnees-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  document.getElementById('excelCount').textContent = cmds.length;
}

// ‚úÖ GLOBE 3D FONCTIONS
function initPaysSelect() {
  const select = document.getElementById('paysIn');
  Object.entries(paysData).sort((a,b) => a[1].name.localeCompare(b[1].name)).forEach(([code, data]) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = `${data.name} (${code})`;
    select.appendChild(option);
  });
}

function initGlobe() {
  const globe = document.getElementById('globe');
  Object.entries(paysData).forEach(([code, data]) => {
    const country = document.createElement('div');
    country.className = 'country';
    country.id = code;
    country.style.background = data.color;
    country.style.width = '25px';
    country.style.height = '25px';
    country.innerHTML = `<span style="font-size:9px;">${code}</span>`;
    country.style.left = `${50 + 20 * Math.cos(data.lng * Math.PI/180) * Math.cos(data.lat * Math.PI/180)}%`;
    country.style.top = `${50 - 20 * Math.sin(data.lat * Math.PI/180)}%`;
    country.onclick = () => showCountryInfo(code);
    globe.appendChild(country);
  });
  updateGlobe();
}

function rotateGlobe(e) {
  isDragging = true;
  const globe = document.getElementById('globe');
  document.onmousemove = (e2) => {
    globeRotation.y += (e2.clientX - e.clientX) * 0.5;
    globeRotation.x += (e2.clientY - e.clientY) * 0.5;
    updateGlobe();
  };
  document.onmouseup = () => { isDragging = false; document.onmousemove = null; };
}

function updateGlobe() {
  const globe = document.getElementById('globe');
  globe.style.transform = `rotateX(${globeRotation.x}deg) rotateY(${globeRotation.y}deg)`;
}

function getClientsByPays(code) {
  return cmds.filter(c => c.pays === code);
}

function showCountryInfo(code) {
  const data = paysData[code];
  const clients = getClientsByPays(code);
  document.getElementById('countryInfo').innerHTML = `
    <h3>üåç ${data.name} (${code})</h3>
    <p><strong>${data.tonnes.toFixed(1)}T</strong> export√©es</p>
    <p>Clients: ${clients.length}</p>
    <p>Commandes: ${clients.length}</p>
  `;
  document.querySelectorAll('.country').forEach(c => c.classList.remove('active'));
  document.getElementById(code)?.classList.add('active');
}

function updateGlobeData() {
  Object.entries(paysData).forEach(([code, data]) => {
    const clients = getClientsByPays(code);
    data.tonnes = clients.reduce((sum, c) => sum + c.tonnes, 0);
    const countryEl = document.getElementById(code);
    if (countryEl) {
      countryEl.innerHTML = `<span style="font-size:9px;">${code}</span><br><span style="font-size:7px;">${data.tonnes.toFixed(1)}T</span>`;
      countryEl.style.width = `${Math.max(25, 20 + data.tonnes * 2)}px`;
      countryEl.style.height = countryEl.style.width;
    }
  });
}

// ‚úÖ MAJ COMPL√àTE (AVEC TOUTES FONCTIONNALIT√âS)
function maj() {
  const tot = cmds.reduce((s,c) => s + c.tonnes, 0);
  const att = cmds.filter(c => c.statut === 'EN ATTENTE').length;
  const ch = cmds.filter(c => c.statut === 'CHARG√âE').length;

  document.getElementById('totT').innerHTML = tot.toFixed(1) + ' T';
  document.getElementById('att').textContent = att;
  document.getElementById('cha').textContent = ch;
  document.getElementById('em').textContent = cmds.reduce((s,c) => s + c.nbEmails, 0);
  document.getElementById('totalInfo').innerHTML = cmds.length + ' commandes | ' + new Date().toLocaleString('fr-FR');

  const tb = document.getElementById('tab');
  tb.innerHTML = '';
  
  cmds.forEach(c => {
    const tr = document.createElement('tr');
    tr.className = c.statut === 'CHARG√âE' ? 'chargee' : '';
    
    const statutText = c.statut === 'CHARG√âE' ? 
      `CHARG√âE (${c.nbEmails} email${c.nbEmails > 1 ? 's' : ''}${c.derniereDateEmail ? ` - ${c.derniereDateEmail}` : ''})` : 
      'EN ATTENTE';
    
    const btnConfirmer = c.statut === 'EN ATTENTE' ? 
      `<button class="action-btn btn-confirmer" onclick="confirmerEmail('${c.ref}')" title="Confirmer & Email">‚úÖ CONFIRMER</button>` : 
      `<button class="action-btn btn-resent" onclick="confirmerEmail('${c.ref}')" title="Renvoyer email">üìß RENVERSER</button>`;
    
    const btnSupprimer = `<button class="action-btn btn-supprimer" onclick="supprimerCmd('${c.ref}')" title="Supprimer cette commande">üóëÔ∏è SUPPR</button>`;
    
    tr.innerHTML = `
      <td><b>${c.client}</b></td>
      <td>${c.ref}</td>
      <td>${c.date}</td>
      <td>${c.pointDepart}</td>
      <td>${c.pays}</td>
      <td><b>${c.tonnes.toFixed(2)} T</b></td>
      <td>${c.immat}</td>
      <td style="color:${c.statut === 'CHARG√âE' ? '#10b981' : '#f59e0b'}"><b>${statutText}</b></td>
      <td>${btnConfirmer} ${btnSupprimer}</td>
    `;
    tb.appendChild(tr);
  });

  // ‚úÖ LIVE SYNC : Exports + Globe + Top Clients
  document.getElementById('pdfSize').textContent = document.getElementById('totT').textContent;
  document.getElementById('excelCount').textContent = cmds.length;
  updateGlobeData();
  afficherTopClients();
}

// SAUVEGARDE AUTO
setInterval(() => {
  localStorage.setItem('solanaCmds', JSON.stringify(cmds));
}, 30000);

// ‚úÖ INITIALISATION
initPaysSelect();
initGlobe();
maj();
</script>
</body>
</html>

